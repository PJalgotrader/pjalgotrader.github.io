<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bias-Variance Tradeoff | Dr. Pedram Jahangiry</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            padding: 30px 20px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .header .attribution {
            font-size: 1.1em;
            margin: 15px 0;
            opacity: 0.95;
        }

        .header .links {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .header .links a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 600;
        }

        .header .links a:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-website { background: linear-gradient(135deg, #667eea, #764ba2); }
        .btn-youtube { background: linear-gradient(135deg, #ff0000, #cc0000); }
        .btn-github { background: linear-gradient(135deg, #333, #000); }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .intro {
            background: linear-gradient(135deg, #f0f4ff, #e8ecff);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border-left: 5px solid #667eea;
        }

        .intro h3 { color: #4338ca; margin-bottom: 10px; font-size: 1.15em; }
        .intro p { color: #475569; line-height: 1.7; font-size: 0.95em; }

        /* Controls */
        .controls {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #334155;
            font-size: 0.92em;
            white-space: nowrap;
        }

        .control-group input[type="range"] {
            width: 140px;
            cursor: pointer;
        }

        .val {
            font-weight: 700;
            color: #667eea;
            min-width: 24px;
            text-align: center;
            font-size: 1.1em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-bulk {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .draw-count {
            font-size: 0.88em;
            color: #64748b;
            font-weight: 500;
            margin-left: auto;
        }

        .draw-count strong {
            color: #667eea;
            font-size: 1.1em;
        }

        /* Complexity indicator */
        .complexity-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 14px 20px;
            border-radius: 10px;
            transition: all 0.4s ease;
        }

        .complexity-bar .tag {
            padding: 5px 14px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.88em;
            color: white;
        }

        .complexity-bar .desc {
            font-size: 0.9em;
            color: #475569;
            line-height: 1.5;
        }

        .complexity-bar .desc strong { color: #1e293b; }

        /* Charts grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-box {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .chart-box .chart-title {
            padding: 10px 16px;
            font-weight: 700;
            font-size: 0.92em;
            color: #334155;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Metrics cards */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
            margin-bottom: 20px;
        }

        .metric-card {
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .metric-card .metric-label {
            font-size: 0.78em;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .metric-card .metric-value {
            font-size: 1.5em;
            font-weight: 800;
        }

        .metric-card .metric-note {
            font-size: 0.72em;
            color: #94a3b8;
            margin-top: 4px;
        }

        .mc-bias { border-color: #3b82f6; }
        .mc-bias .metric-value { color: #2563eb; }

        .mc-var { border-color: #f59e0b; }
        .mc-var .metric-value { color: #d97706; }

        .mc-irr { border-color: #94a3b8; }
        .mc-irr .metric-value { color: #64748b; }

        .mc-total { border-color: #ef4444; }
        .mc-total .metric-value { color: #dc2626; }

        /* Equation bar */
        .equation-bar {
            text-align: center;
            padding: 14px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.05em;
            color: #334155;
        }

        .equation-bar .eq-part { font-weight: 700; }
        .eq-bias { color: #2563eb; }
        .eq-var { color: #d97706; }
        .eq-irr { color: #64748b; }
        .eq-total { color: #dc2626; }

        @media (max-width: 900px) {
            .header h1 { font-size: 1.6em; }
            .container { padding: 20px; }
            .charts-grid { grid-template-columns: 1fr; }
            .metrics-row { grid-template-columns: repeat(2, 1fr); }
            .controls { flex-direction: column; align-items: stretch; gap: 10px; }
            .draw-count { margin-left: 0; text-align: center; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>The Bias-Variance Tradeoff</h1>
    <div class="subtitle">Module 5 — Machine Learning for Time Series Forecasting</div>
    <div class="attribution">Created by Dr. Pedram Jahangiry | Enhanced with Claude</div>
    <div class="links">
        <a href="https://pjalgotrader.github.io" class="btn-website">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            Website
        </a>
        <a href="https://www.youtube.com/@pedramjahangiry" class="btn-youtube">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.4.6A3 3 0 0 0 .5 6.2 31.5 31.5 0 0 0 0 12a31.5 31.5 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c1.9.6 9.4.6 9.4.6s7.5 0 9.4-.6a3 3 0 0 0 2.1-2.1A31.5 31.5 0 0 0 24 12a31.5 31.5 0 0 0-.5-5.8zM9.6 15.6V8.4L16 12l-6.4 3.6z"/></svg>
            YouTube
        </a>
        <a href="https://github.com/pjalgotrader" class="btn-github">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12c0 5.3 3.4 9.8 8.2 11.4.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.5-1.4-1.3-1.8-1.3-1.8-1.1-.7.1-.7.1-.7 1.2.1 1.8 1.2 1.8 1.2 1.1 1.8 2.8 1.3 3.5 1 .1-.8.4-1.3.7-1.6-2.7-.3-5.5-1.3-5.5-5.9 0-1.3.5-2.4 1.2-3.2-.1-.3-.5-1.5.1-3.2 0 0 1-.3 3.3 1.2a11.5 11.5 0 0 1 6 0C17.3 4.7 18.3 5 18.3 5c.7 1.7.2 2.9.1 3.2.8.8 1.2 1.9 1.2 3.2 0 4.6-2.8 5.6-5.5 5.9.4.4.8 1.1.8 2.2v3.3c0 .3.2.7.8.6A12 12 0 0 0 24 12C24 5.4 18.6 0 12 0z"/></svg>
            GitHub
        </a>
    </div>
</div>

<div class="container">

    <div class="intro">
        <h3>Understanding Bias and Variance Through Repeated Sampling</h3>
        <p>
            The <strong>true relationship</strong> between x and y is a quadratic function (degree 2) plus random noise.
            You don't know this — you only observe noisy samples of 20 points.
            Each time you click <strong>"Draw Sample"</strong>, a fresh sample of 20 points is generated and a polynomial
            of your chosen degree is fit to it. By drawing many samples, you can see how the fitted model behaves
            <em>across repeated experiments</em>.
        </p>
        <p style="margin-top:10px;">
            <strong>Bias</strong> = how far the <em>average</em> prediction is from the truth (systematic error).
            <strong>Variance</strong> = how much predictions <em>scatter</em> across different samples (instability).
            A simple model (degree 0 or 1) is stable but consistently wrong — <span style="color:#2563eb;font-weight:600;">high bias</span>.
            A complex model (degree 3 or 4) has extra parameters and changes more between samples — <span style="color:#d97706;font-weight:600;">high variance</span>.
        </p>
    </div>

    <!-- Mathematical Definitions -->
    <div style="background:#f8fafc; border-radius:12px; padding:20px 24px; margin-bottom:20px; border:2px solid #e2e8f0;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
            <div>
                <div style="font-weight:700; color:#2563eb; margin-bottom:8px; font-size:0.95em;">Bias² — Systematic Error</div>
                <div style="background:white; padding:12px 16px; border-radius:8px; border-left:4px solid #2563eb; font-family:'Courier New',monospace; font-size:0.88em; color:#334155; line-height:1.8;">
                    Bias[f&#x0302;(x)] = E[f&#x0302;(x)] &minus; f(x)<br>
                    <span style="color:#64748b; font-family:inherit; font-size:0.92em;">
                        How far is the <strong>average prediction</strong><br>
                        across all samples from the <strong>truth</strong>?
                    </span>
                </div>
            </div>
            <div>
                <div style="font-weight:700; color:#d97706; margin-bottom:8px; font-size:0.95em;">Variance — Instability</div>
                <div style="background:white; padding:12px 16px; border-radius:8px; border-left:4px solid #d97706; font-family:'Courier New',monospace; font-size:0.88em; color:#334155; line-height:1.8;">
                    Var[f&#x0302;(x)] = E[(f&#x0302;(x) &minus; E[f&#x0302;(x)])&sup2;]<br>
                    <span style="color:#64748b; font-family:inherit; font-size:0.92em;">
                        How much do <strong>individual predictions</strong><br>
                        vary around their <strong>average</strong>?
                    </span>
                </div>
            </div>
        </div>
        <div style="margin-top:14px; background:white; padding:12px 16px; border-radius:8px; border-left:4px solid #dc2626; text-align:center;">
            <span style="font-family:'Courier New',monospace; font-size:0.92em; color:#334155;">
                <span style="color:#dc2626; font-weight:700;">E[Test Error]</span> =
                <span style="color:#2563eb; font-weight:700;">Bias&sup2;</span> +
                <span style="color:#d97706; font-weight:700;">Variance</span> +
                <span style="color:#64748b; font-weight:700;">&sigma;&sup2;</span>
                <span style="color:#94a3b8;">&nbsp;&nbsp;(irreducible noise)</span>
            </span>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="control-group">
            <label>Polynomial Degree:</label>
            <input type="range" id="degree-slider" min="0" max="4" value="2" />
            <span class="val" id="degree-val">2</span>
        </div>
        <button class="btn btn-primary" id="btn-draw">Draw Sample</button>
        <button class="btn btn-bulk" id="btn-bulk">Draw 25 Samples</button>
        <button class="btn btn-reset" id="btn-reset">Reset</button>
        <div class="draw-count">Draws: <strong id="draw-count">0</strong></div>
    </div>

    <!-- Complexity indicator -->
    <div class="complexity-bar" id="complexity-bar">
        <span class="tag" id="complexity-tag">Good Balance</span>
        <span class="desc" id="complexity-desc"></span>
    </div>

    <!-- Equation -->
    <div class="equation-bar">
        Expected Test Error = <span class="eq-part eq-bias">Bias²</span>
        + <span class="eq-part eq-var">Variance</span>
        + <span class="eq-part eq-irr">Irreducible Noise</span>
        = <span class="eq-part eq-total" id="eq-total-val">—</span>
        <span id="eq-source" style="font-size:0.78em; color:#94a3b8; margin-left:10px;"></span>
    </div>

    <!-- Metrics cards -->
    <div class="metrics-row">
        <div class="metric-card mc-bias">
            <div class="metric-label">Bias²</div>
            <div class="metric-value" id="m-bias">—</div>
            <div class="metric-note" id="m-bias-note">Draw samples to estimate</div>
        </div>
        <div class="metric-card mc-var">
            <div class="metric-label">Variance</div>
            <div class="metric-value" id="m-var">—</div>
            <div class="metric-note" id="m-var-note">Draw samples to estimate</div>
        </div>
        <div class="metric-card mc-irr">
            <div class="metric-label">Irreducible Noise (σ²)</div>
            <div class="metric-value" id="m-irr">9.00</div>
            <div class="metric-note">Cannot be reduced</div>
        </div>
        <div class="metric-card mc-total">
            <div class="metric-label">Total Expected Error</div>
            <div class="metric-value" id="m-total">—</div>
            <div class="metric-note" id="m-total-note">Bias² + Variance + σ²</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <div class="chart-box">
            <div class="chart-title">Fitted Models on Repeated Samples</div>
            <div id="chart-fits" style="height:420px;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">Bias-Variance Tradeoff Curve</div>
            <div id="chart-tradeoff" style="height:420px;"></div>
        </div>
    </div>

</div>

<script>
// ============================================================
// TRUE FUNCTION & CONSTANTS
// ============================================================
const NOISE_SD = 3.0;
const NOISE_VAR = NOISE_SD * NOISE_SD;  // σ² = 9
const N_SAMPLES = 20;
const X_MIN = -3, X_MAX = 3;

// True function: y = 0.8x² - 0.5x + 2  (quadratic = degree 2)
function trueF(x) {
    return 0.8 * x * x - 0.5 * x + 2;
}

// Dense evaluation grid (use NORMALIZED x for numerical stability)
const N_GRID = 60;
const xGrid = [];       // original x values for plotting
const xGridNorm = [];   // normalized to [0,1] for polynomial fitting
for (let i = 0; i < N_GRID; i++) {
    const x = X_MIN + (X_MAX - X_MIN) * i / (N_GRID - 1);
    xGrid.push(x);
    xGridNorm.push((x - X_MIN) / (X_MAX - X_MIN));  // maps to [0, 1]
}
const yTrueGrid = xGrid.map(trueF);

// ============================================================
// POLYNOMIAL FITTING — normalized x to [0,1] for stability
// ============================================================
function normalizeX(xArr) {
    return xArr.map(x => (x - X_MIN) / (X_MAX - X_MIN));
}

function fitPoly(xNorm, yArr, deg) {
    // Fit polynomial of given degree on normalized x in [0,1]
    // Degree 0 = constant (mean)
    const n = xNorm.length;
    const p = deg + 1;

    // Build X^T X and X^T y
    const XtX = Array.from({length: p}, () => new Float64Array(p));
    const XtY = new Float64Array(p);

    for (let i = 0; i < n; i++) {
        const xi = xNorm[i];
        // Build row of [1, xi, xi², ...]
        const row = new Float64Array(p);
        row[0] = 1;
        for (let d = 1; d < p; d++) row[d] = row[d-1] * xi;

        for (let j = 0; j < p; j++) {
            XtY[j] += row[j] * yArr[i];
            for (let k = j; k < p; k++) {
                XtX[j][k] += row[j] * row[k];
            }
        }
    }
    // Symmetrise
    for (let j = 0; j < p; j++)
        for (let k = 0; k < j; k++)
            XtX[j][k] = XtX[k][j];

    // Small ridge for numerical stability
    for (let j = 0; j < p; j++) XtX[j][j] += 1e-10;

    // Gaussian elimination with partial pivoting
    const A = XtX.map(row => Array.from(row));
    const b = Array.from(XtY);

    for (let col = 0; col < p; col++) {
        let maxVal = Math.abs(A[col][col]), maxRow = col;
        for (let row = col + 1; row < p; row++) {
            if (Math.abs(A[row][col]) > maxVal) { maxVal = Math.abs(A[row][col]); maxRow = row; }
        }
        [A[col], A[maxRow]] = [A[maxRow], A[col]];
        [b[col], b[maxRow]] = [b[maxRow], b[col]];
        for (let row = col + 1; row < p; row++) {
            const factor = A[row][col] / A[col][col];
            for (let k = col; k < p; k++) A[row][k] -= factor * A[col][k];
            b[row] -= factor * b[col];
        }
    }

    const coeffs = new Float64Array(p);
    for (let i = p - 1; i >= 0; i--) {
        let sum = b[i];
        for (let j = i + 1; j < p; j++) sum -= A[i][j] * coeffs[j];
        coeffs[i] = sum / A[i][i];
    }
    return Array.from(coeffs);
}

function evalPoly(coeffs, xNorm) {
    // Evaluate polynomial at normalized x
    let y = 0, xp = 1;
    for (let d = 0; d < coeffs.length; d++) {
        y += coeffs[d] * xp;
        xp *= xNorm;
    }
    return y;
}

// ============================================================
// RANDOM SAMPLING
// ============================================================
function randn() {
    let u = 0, v = 0;
    while (u === 0) u = Math.random();
    while (v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function drawSample() {
    const xs = [], xsNorm = [], ys = [];
    for (let i = 0; i < N_SAMPLES; i++) {
        const x = X_MIN + (X_MAX - X_MIN) * Math.random();
        xs.push(x);
        xsNorm.push((x - X_MIN) / (X_MAX - X_MIN));
        ys.push(trueF(x) + NOISE_SD * randn());
    }
    return {xs, xsNorm, ys};
}

// ============================================================
// PRE-COMPUTE STATIC TRADEOFF CURVE (Monte Carlo, 500 draws)
// ============================================================
const MC_DRAWS = 500;
const MAX_DEG = 4;
const tradeoffData = {degrees: [], bias2: [], variance: [], total: [], noise: []};

function precomputeTradeoff() {
    // Generate 500 samples once
    const mcSamples = [];
    for (let i = 0; i < MC_DRAWS; i++) mcSamples.push(drawSample());

    for (let deg = 0; deg <= MAX_DEG; deg++) {
        // For each sample, fit the polynomial and predict on the grid
        const allPreds = [];  // [draw][gridPt]
        for (let i = 0; i < MC_DRAWS; i++) {
            const s = mcSamples[i];
            const coeffs = fitPoly(s.xsNorm, s.ys, deg);
            allPreds.push(xGridNorm.map(xn => evalPoly(coeffs, xn)));
        }

        // Average prediction at each grid point
        const avgPred = new Float64Array(N_GRID);
        for (let j = 0; j < N_GRID; j++) {
            for (let i = 0; i < MC_DRAWS; i++) avgPred[j] += allPreds[i][j];
            avgPred[j] /= MC_DRAWS;
        }

        // Bias² and Variance averaged over grid
        let bias2Sum = 0, varSum = 0;
        for (let j = 0; j < N_GRID; j++) {
            const diff = avgPred[j] - yTrueGrid[j];
            bias2Sum += diff * diff;
            let v = 0;
            for (let i = 0; i < MC_DRAWS; i++) {
                const d = allPreds[i][j] - avgPred[j];
                v += d * d;
            }
            varSum += v / MC_DRAWS;
        }

        tradeoffData.degrees.push(deg);
        tradeoffData.bias2.push(bias2Sum / N_GRID);
        tradeoffData.variance.push(varSum / N_GRID);
        tradeoffData.noise.push(NOISE_VAR);
        tradeoffData.total.push(bias2Sum / N_GRID + varSum / N_GRID + NOISE_VAR);
    }
}

// Run the Monte Carlo computation
precomputeTradeoff();

// ============================================================
// STATE for user's interactive draws
// ============================================================
let allDraws = [];   // {xs, xsNorm, ys, coeffs, yPredGrid}
let currentDegree = 2;

const DRAW_COLORS = [
    'rgba(99,102,241,0.3)', 'rgba(236,72,153,0.3)', 'rgba(34,197,94,0.3)',
    'rgba(249,115,22,0.3)', 'rgba(14,165,233,0.3)', 'rgba(168,85,247,0.3)',
    'rgba(234,179,8,0.3)',  'rgba(239,68,68,0.3)',   'rgba(20,184,166,0.3)',
    'rgba(107,114,128,0.3)'
];

// ============================================================
// CONTROLS
// ============================================================
const degreeSlider = document.getElementById('degree-slider');
const degreeVal = document.getElementById('degree-val');

degreeSlider.addEventListener('input', () => {
    currentDegree = parseInt(degreeSlider.value);
    degreeVal.textContent = currentDegree;
    updateComplexityIndicator();
    refitAll();
});

document.getElementById('btn-draw').addEventListener('click', () => addDraw());

document.getElementById('btn-bulk').addEventListener('click', () => {
    for (let i = 0; i < 25; i++) addDraw();
});

document.getElementById('btn-reset').addEventListener('click', () => {
    allDraws = [];
    document.getElementById('draw-count').textContent = '0';
    updateMetrics();
    renderFitsChart();
    updateTradeoffMarker();
});

// ============================================================
// COMPLEXITY INDICATOR
// ============================================================
function updateComplexityIndicator() {
    const bar = document.getElementById('complexity-bar');
    const tag = document.getElementById('complexity-tag');
    const desc = document.getElementById('complexity-desc');
    const d = currentDegree;

    if (d === 0) {
        bar.style.background = 'linear-gradient(135deg, #dbeafe, #bfdbfe)';
        tag.style.background = '#2563eb';
        tag.textContent = 'Underfitting';
        desc.innerHTML = '<strong>Degree 0 (constant):</strong> Predicts the same value everywhere — just the mean. ' +
            '<strong>High bias</strong> (misses all structure), <strong>zero variance</strong> (perfectly stable).';
    } else if (d === 1) {
        bar.style.background = 'linear-gradient(135deg, #dbeafe, #bfdbfe)';
        tag.style.background = '#2563eb';
        tag.textContent = 'Underfitting';
        desc.innerHTML = '<strong>Degree 1 (linear):</strong> A straight line cannot capture the quadratic curvature. ' +
            '<strong>High bias</strong> (systematically wrong), <strong>low variance</strong> (stable across samples).';
    } else if (d === 2) {
        bar.style.background = 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
        tag.style.background = '#059669';
        tag.textContent = 'Good Balance';
        desc.innerHTML = '<strong>Degree 2 (quadratic):</strong> Matches the true function! ' +
            '<strong>Low bias</strong> and <strong>low variance</strong> — the sweet spot.';
    } else if (d === 3) {
        bar.style.background = 'linear-gradient(135deg, #fef9c3, #fde68a)';
        tag.style.background = '#b45309';
        tag.textContent = 'Slightly Complex';
        desc.innerHTML = '<strong>Degree 3 (cubic):</strong> One extra parameter beyond what\'s needed. Bias stays low ' +
            'but <strong>variance starts to grow</strong> — the cubic term begins fitting noise.';
    } else {
        bar.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
        tag.style.background = '#dc2626';
        tag.textContent = 'Overfitting';
        desc.innerHTML = '<strong>Degree 4 (quartic):</strong> Two extra parameters beyond what\'s needed. ' +
            '<strong>Low bias</strong> but <strong>noticeably higher variance</strong> — the model wiggles between samples, fitting noise.';
    }
}

// ============================================================
// ADD A DRAW & REFIT
// ============================================================
function addDraw() {
    const sample = drawSample();
    const coeffs = fitPoly(sample.xsNorm, sample.ys, currentDegree);
    const yPredGrid = xGridNorm.map(xn => evalPoly(coeffs, xn));
    allDraws.push({xs: sample.xs, xsNorm: sample.xsNorm, ys: sample.ys, coeffs, yPredGrid});
    document.getElementById('draw-count').textContent = allDraws.length;
    updateMetrics();
    renderFitsChart();
    updateTradeoffMarker();
}

function refitAll() {
    for (let i = 0; i < allDraws.length; i++) {
        const d = allDraws[i];
        d.coeffs = fitPoly(d.xsNorm, d.ys, currentDegree);
        d.yPredGrid = xGridNorm.map(xn => evalPoly(d.coeffs, xn));
    }
    updateMetrics();
    renderFitsChart();
    updateTradeoffMarker();
}

// ============================================================
// METRICS (from user's draws for the current degree)
// ============================================================
function computeUserBiasVar() {
    if (allDraws.length < 2) return null;
    const nDraws = allDraws.length;

    const avgPred = new Float64Array(N_GRID);
    for (let j = 0; j < N_GRID; j++) {
        for (let i = 0; i < nDraws; i++) avgPred[j] += allDraws[i].yPredGrid[j];
        avgPred[j] /= nDraws;
    }

    let bias2Sum = 0, varSum = 0;
    for (let j = 0; j < N_GRID; j++) {
        const diff = avgPred[j] - yTrueGrid[j];
        bias2Sum += diff * diff;
        let v = 0;
        for (let i = 0; i < nDraws; i++) {
            const d = allDraws[i].yPredGrid[j] - avgPred[j];
            v += d * d;
        }
        varSum += v / nDraws;
    }

    return { bias2: bias2Sum / N_GRID, variance: varSum / N_GRID };
}

function updateMetrics() {
    const nDraws = allDraws.length;

    if (nDraws < 2) {
        // Not enough draws — show placeholder
        document.getElementById('m-bias').textContent = nDraws === 0 ? '—' : 'Need 2+';
        document.getElementById('m-var').textContent = nDraws === 0 ? '—' : 'Need 2+';
        document.getElementById('m-total').textContent = '—';
        document.getElementById('eq-total-val').textContent = '—';
        document.getElementById('eq-source').textContent = '';
        document.getElementById('m-bias-note').textContent = 'Draw samples to estimate';
        document.getElementById('m-var-note').textContent = 'Draw samples to estimate';
        document.getElementById('m-total-note').textContent = 'Bias² + Variance + σ²';
        return;
    }

    // Compute from user's actual draws
    const result = computeUserBiasVar();
    const bias2 = result.bias2;
    const variance = result.variance;
    const total = bias2 + variance + NOISE_VAR;

    document.getElementById('m-bias').textContent = bias2.toFixed(2);
    document.getElementById('m-var').textContent = variance.toFixed(2);
    document.getElementById('m-total').textContent = total.toFixed(2);
    document.getElementById('eq-total-val').textContent = total.toFixed(2);

    // Show source info
    const srcText = `(estimated from your ${nDraws} draw${nDraws > 1 ? 's' : ''})`;
    document.getElementById('eq-source').textContent = srcText;

    // Notes with convergence hint
    const mcBias = tradeoffData.bias2[currentDegree];
    const mcVar = tradeoffData.variance[currentDegree];
    if (nDraws < 10) {
        document.getElementById('m-bias-note').textContent = `From ${nDraws} draws — keep drawing!`;
        document.getElementById('m-var-note').textContent = `From ${nDraws} draws — keep drawing!`;
        document.getElementById('m-total-note').textContent = `Estimates stabilize with more draws`;
    } else {
        document.getElementById('m-bias-note').textContent = `From ${nDraws} draws (MC ≈ ${mcBias.toFixed(2)})`;
        document.getElementById('m-var-note').textContent = `From ${nDraws} draws (MC ≈ ${mcVar.toFixed(2)})`;
        document.getElementById('m-total-note').textContent = `Converging toward MC estimate`;
    }
}

// ============================================================
// CHART: Fitted Models (left chart — interactive)
// ============================================================
function renderFitsChart() {
    const traces = [];

    // True function
    traces.push({
        x: xGrid, y: yTrueGrid,
        mode: 'lines',
        name: 'True Function (degree 2)',
        line: {color: '#000', width: 3, dash: 'dash'},
        hoverinfo: 'skip'
    });

    // All fitted curves
    for (let i = 0; i < allDraws.length; i++) {
        const d = allDraws[i];
        const isLatest = i === allDraws.length - 1;
        traces.push({
            x: xGrid,
            y: d.yPredGrid,
            mode: 'lines',
            name: isLatest ? `Draw ${i+1} (latest)` : `Draw ${i+1}`,
            line: {
                color: isLatest ? 'rgba(99,102,241,0.9)' : DRAW_COLORS[i % DRAW_COLORS.length],
                width: isLatest ? 2.5 : 1.2
            },
            showlegend: isLatest || allDraws.length <= 5,
            hoverinfo: 'skip'
        });
    }

    // Average prediction (if >= 2 draws)
    if (allDraws.length >= 2) {
        const avgY = xGrid.map((_, j) => {
            let s = 0;
            for (const d of allDraws) s += d.yPredGrid[j];
            return s / allDraws.length;
        });
        traces.push({
            x: xGrid, y: avgY,
            mode: 'lines',
            name: `Average of ${allDraws.length} Draws`,
            line: {color: '#dc2626', width: 3},
            hoverinfo: 'skip'
        });
    }

    // Latest sample points
    if (allDraws.length > 0) {
        const latest = allDraws[allDraws.length - 1];
        traces.push({
            x: latest.xs, y: latest.ys,
            mode: 'markers',
            name: 'Latest Sample (n=20)',
            marker: {color: '#6366f1', size: 7, opacity: 0.7,
                     line: {color: 'white', width: 1}},
            hoverinfo: 'x+y'
        });
    }

    Plotly.react('chart-fits', traces, {
        margin: {t: 10, r: 20, b: 45, l: 50},
        xaxis: {title: 'x', range: [X_MIN - 0.3, X_MAX + 0.3], gridcolor: '#f1f5f9'},
        yaxis: {title: 'y', range: [-8, 18], gridcolor: '#f1f5f9'},
        legend: {x: 0.01, y: 0.99, bgcolor: 'rgba(255,255,255,0.85)', font: {size: 10}},
        plot_bgcolor: 'white',
        paper_bgcolor: 'white',
        hovermode: 'closest'
    }, {responsive: true, displayModeBar: false});
}

// ============================================================
// CHART: Bias-Variance Tradeoff (right chart — STATIC curve)
// ============================================================
function renderTradeoffChart() {
    const traces = [
        {
            x: tradeoffData.degrees, y: tradeoffData.bias2,
            mode: 'lines+markers', name: 'Bias²',
            line: {color: '#2563eb', width: 3, shape: 'spline'},
            marker: {size: 8}
        },
        {
            x: tradeoffData.degrees, y: tradeoffData.variance,
            mode: 'lines+markers', name: 'Variance',
            line: {color: '#d97706', width: 3, shape: 'spline'},
            marker: {size: 8}
        },
        {
            x: tradeoffData.degrees, y: tradeoffData.total,
            mode: 'lines+markers', name: 'Total Error (Bias² + Var + σ²)',
            line: {color: '#dc2626', width: 3, dash: 'dot', shape: 'spline'},
            marker: {size: 8}
        },
        {
            x: tradeoffData.degrees, y: tradeoffData.noise,
            mode: 'lines', name: 'Irreducible Noise (σ²)',
            line: {color: '#94a3b8', width: 2, dash: 'dash'}
        },
        // Current degree marker
        {
            x: [currentDegree],
            y: [tradeoffData.total[currentDegree]],
            mode: 'markers',
            name: 'Current Degree',
            marker: {color: '#dc2626', size: 16, symbol: 'star',
                     line: {color: 'white', width: 2}},
            showlegend: true
        }
    ];

    // Find optimum
    let minTotal = Infinity, optDeg = 0;
    tradeoffData.total.forEach((v, i) => { if (v < minTotal) { minTotal = v; optDeg = i; } });

    Plotly.react('chart-tradeoff', traces, {
        margin: {t: 10, r: 20, b: 45, l: 55},
        xaxis: {
            title: 'Model Complexity (Polynomial Degree)',
            dtick: 1,
            range: [-0.3, MAX_DEG + 0.3],
            gridcolor: '#f1f5f9'
        },
        yaxis: {
            title: 'Error',
            rangemode: 'tozero',
            gridcolor: '#f1f5f9'
        },
        legend: {x: 0.45, y: 0.99, bgcolor: 'rgba(255,255,255,0.85)', font: {size: 10}},
        plot_bgcolor: 'white',
        paper_bgcolor: 'white',
        shapes: [{
            type: 'line', x0: optDeg, x1: optDeg,
            y0: 0, y1: minTotal * 1.4,
            line: {color: '#059669', width: 2, dash: 'dot'}
        }],
        annotations: [{
            x: optDeg, y: minTotal * 1.35,
            text: 'Optimum<br>(degree ' + optDeg + ')',
            showarrow: false,
            font: {size: 11, color: '#059669'},
            bgcolor: 'rgba(255,255,255,0.8)'
        }],
        hovermode: 'x unified'
    }, {responsive: true, displayModeBar: false});
}

function updateTradeoffMarker() {
    // Just move the star marker on the static chart
    Plotly.restyle('chart-tradeoff', {
        x: [[currentDegree]],
        y: [[tradeoffData.total[currentDegree]]],
        name: 'Current Degree'
    }, [4]);  // trace index 4 = the star marker
}

// ============================================================
// INIT
// ============================================================
updateComplexityIndicator();
updateMetrics();
renderFitsChart();
renderTradeoffChart();
</script>

</body>
</html>
